name: CI/CD æŒç»­é›†æˆæµæ°´çº¿

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: è®¾ç½® Python ${{ matrix.python-version }} ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # å®‰è£…é¢å¤–çš„æµ‹è¯•ä¾èµ–
        pip install pytest pytest-asyncio pytest-cov flake8

    - name: éªŒè¯ Python è¯­æ³•
      run: |
        echo "æ­£åœ¨æ£€æŸ¥æ‰€æœ‰ Python æ–‡ä»¶çš„è¯­æ³•..."
        find . -name "*.py" -type f -exec python -m py_compile {} \;
        echo "âœ… æ‰€æœ‰ Python æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡"

    - name: ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        echo "æ­£åœ¨è¿›è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
        # ä¸¥é‡é”™è¯¯ä¼šå¯¼è‡´æ„å»ºå¤±è´¥
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # å°†å…¶ä»–é”™è¯¯è§†ä¸ºè­¦å‘Š
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥å®Œæˆ"

    - name: æ£€æŸ¥æµ‹è¯•æ–‡ä»¶
      id: check_tests
      run: |
        echo "æ­£åœ¨æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶..."
        # æ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨æµ‹è¯•æ–‡ä»¶
        if [ -d "tests" ] || find . -name "*test*.py" -type f | grep -q .; then
          echo "tests_exist=true" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶"
        else
          echo "tests_exist=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶"
        fi

    - name: è¿è¡Œæµ‹è¯•
      if: steps.check_tests.outputs.tests_exist == 'true'
      run: |
        echo "å¼€å§‹è¿è¡Œæµ‹è¯•..."
        # è¿è¡Œæ‰¾åˆ°çš„æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
        if [ -d "tests" ]; then
          echo "åœ¨ tests ç›®å½•ä¸­è¿è¡Œæµ‹è¯•"
          pytest tests -v --cov=chatbot --cov-report=xml --cov-report=html
        else
          echo "æŸ¥æ‰¾å¹¶è¿è¡Œç‹¬ç«‹çš„æµ‹è¯•æ–‡ä»¶"
          find . -name "*test*.py" -type f -exec pytest {} -v \;
        fi
        echo "âœ… æµ‹è¯•è¿è¡Œå®Œæˆ"
      env:
        # å¦‚æœæ²¡æœ‰æä¾› secretsï¼Œä¸º CI è®¾ç½®è™šæ‹Ÿå€¼
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY || 'dummy-key-for-ci' }}
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY || 'dummy-key-for-ci' }}

    - name: è¿è¡Œå¯¼å…¥éªŒè¯
      if: steps.check_tests.outputs.tests_exist == 'false'
      run: |
        echo "æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•ï¼Œæ­£åœ¨è¿è¡Œå¯¼å…¥éªŒè¯..."
        # æµ‹è¯•ä¸»æ¨¡å—å¯¼å…¥
        echo "  - æµ‹è¯•ä¸»æ¨¡å—å¯¼å…¥..."
        python -c "
        try:
            import sys
            sys.path.append('.')
            from chatbot import ChatBot
            print('âœ… ChatBot æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ ChatBot æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)
        "

        # æµ‹è¯•å„ä¸ªå­æ¨¡å—å¯¼å…¥
        echo "  - æµ‹è¯•å­æ¨¡å—å¯¼å…¥..."
        python -c "
        try:
            from chatbot import config, logger, utils
            from chatbot.TavilySearchToolNode import ToolExecutionNode
            print('âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)
        "
        echo "âœ… å¯¼å…¥éªŒè¯å®Œæˆ"

    - name: åŸºç¡€åŠŸèƒ½æµ‹è¯•
      run: |
        echo "æ­£åœ¨è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•..."
        python -c "
        import os
        os.environ['DEEPSEEK_API_KEY'] = 'test-key'
        os.environ['TAVILY_API_KEY'] = 'test-key'

        try:
            # æµ‹è¯•é…ç½®åŠ è½½
            print('  - æµ‹è¯•é…ç½®åŠ è½½...')
            from chatbot.config import ChatConfig
            config = ChatConfig()
            print('âœ… é…ç½®åŠ è½½æˆåŠŸ')

            # æµ‹è¯•æ—¥å¿—ç³»ç»Ÿ
            print('  - æµ‹è¯•æ—¥å¿—ç³»ç»Ÿ...')
            from chatbot.logger import setup_logger
            logger = setup_logger('test')
            print('âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ')

            # æµ‹è¯•å·¥å…·å‡½æ•°
            print('  - æµ‹è¯•å·¥å…·å‡½æ•°...')
            from chatbot.utils import sanitize_user_input, count_tokens
            sanitized = sanitize_user_input('test input')
            print(f'âœ… å·¥å…·å‡½æ•°æ­£å¸¸å·¥ä½œ: sanitized={sanitized}')

            print('âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡')
        except Exception as e:
            print(f'âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      if: steps.check_tests.outputs.tests_exist == 'true'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        echo "ğŸš€ æ­£åœ¨éƒ¨ç½²åº”ç”¨..."
        echo "è¿™æ˜¯ä¸€ä¸ªéƒ¨ç½²æ­¥éª¤çš„å ä½ç¬¦"
        echo "å…¸å‹çš„éƒ¨ç½²æ­¥éª¤å¯èƒ½åŒ…æ‹¬ï¼š"
        echo "- æ„å»º Docker é•œåƒ"
        echo "- æ¨é€åˆ°é•œåƒä»“åº“"
        echo "- æ›´æ–° Kubernetes éƒ¨ç½²"
        echo "- è¿è¡Œæ•°æ®åº“è¿ç§»"
        echo "- å¥åº·æ£€æŸ¥"
        echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆ"